#!/bin/bash
#
# This file is released under terms of BSD license
# See LICENSE file for more information
#
# clawfc
# Compiler driver for the claw language translation for Fortran language.
# This driver is based on the xmpf90 compiler driver from the OMNI Compiler
# project.
# https://github.com/omni-compiler/omni-compiler/blob/master/Driver/bin/
#   xmpf90.in
#
# author: clementval
#

## TODO cp original file in case of error

### Read configration file and library ###
om_cx2x_driver_conf_dir=@OM_CX2X_DRIVER_CONF_DIR@
om_cx2x_driver_lib_dir=@OM_CX2X_DRIVER_LIB_DIR@
# shellcheck source=../etc/claw_f.conf.in
. ${om_cx2x_driver_conf_dir}/@CLAW_CONF_FILE@
# shellcheck source=../libexec/claw_f_lib.sh.in
. ${om_cx2x_driver_lib_dir}/@CLAW_LIB_SH@

### Directory for saving intermediate files ###
current_pid=$$
temp_dir=/tmp/__omni_tmp__${current_pid}
debug_temp_dir="__omni_tmp__"

### Default options ###
fpp_redirect=@FPP_REDIRECT@
only_pp=false
enable_cpp=true
verbose=false
enable_debug=false
enable_debug_omni=false
resolve_dependencies=true
stop_pp=false
stop_frontend=false
stop_translator=false
stop_dependencies=false
force_translation=false
list_target=false
list_directive=false
show_config=false
user_target=false
user_config=false
user_directive=false
line_directive=false
decompiler_max_column=false
dump_cx2x_args=false
force_pure=false
report=false

### Set options ###
# e.g.) clawfc -I/usr/lib myfile.f90
#
#  output_file="a.out"           # Output file
#  f_files="a.f b.F c.f90 d.F90" # All fortran files
#  other_args="-I/usr/lib"       # Options for Preprocessor, Compiler, and
#                                # Linker
#
# To deal with space-separator in options, the following variables are defined
# as an array
#

output_file=""
output_dir=""
f_files=()
f_files_transformation=()
other_args=()

# Additional options defined by command line (e.g. --Wl..)
pp_add_opt=()
frontend_add_opt=()
xcode_translator_add_opt=()
module_opt=()
trans_module_opt=()
include_opt=()

# CLAW special options
target_opt=""
config_opt=""
directive_opt=""
max_columns=""

claw::set_parameters "${@+"$@"}"

# Set parameter variables as readonly after the set_parameters fct
readonly fpp_redirect
readonly only_pp
readonly enable_cpp
readonly verbose
readonly enable_debug
readonly enable_debug_omni
readonly resolve_dependencies
readonly stop_pp
readonly stop_frontend
readonly stop_translator
readonly stop_dependencies
readonly force_translation
readonly list_target
readonly list_directive
readonly show_config
readonly user_target
readonly user_config
readonly user_directive
readonly line_directive
readonly decompiler_max_column
readonly dump_cx2x_args
readonly force_pure
readonly report

### List target ###
if [[ ${list_target} == true ]]; then
  # shellcheck disable=SC2086
  ${OMNI_FX2X_CMD} ${OMNI_FX2X_OPT} --target-list
  exit 0
fi

### List directive ###
if [[ ${list_directive} == true ]]; then
   # shellcheck disable=SC2086
  ${OMNI_FX2X_CMD} ${OMNI_FX2X_OPT} --directive-list
  exit 0
fi

### Set correct configuration file info ###
if [[ ${user_config} == true ]]; then
  OMNI_CX2X_CONFIG_OPT="--config=${config_opt}"
else
  # Is configuration set through env variable
#  if [[ -z ${CLAW_CONF+x} ]]; then
#    OMNI_CX2X_CONFIG_OPT="--config=${CLAW_CONF_FILE}"
#  else
    # Use the default configuration
    OMNI_CX2X_CONFIG_OPT="--config=${OMNI_CX2X_CONFIG_DEFAULT}"
#  fi
fi
OMNI_CX2X_CONFIG_OPT="$OMNI_CX2X_CONFIG_OPT --schema=${OMNI_CX2X_CONFIG_XSD}"

# Set the correct JARs for transformations
#if [[ -z ${CLAW_TRANS_PATH+x} ]]; then
#  OMNI_CX2X_TRANS_PATH_OPT="--trans=${CLAW_TRANS_PATH}"
#else
#  OMNI_CX2X_TRANS_PATH_OPT="--trans=${OMNI_CX2X_TRANS_DEFAULT}"
#fi

# Set the correct target option for the translator
OMNI_CX2X_TARGET_OPT=""
if [[ ${user_target} == true ]]; then
  OMNI_CX2X_TARGET_OPT="--target=${target_opt}"
fi

# Set the correct directive option for the translator
OMNI_CX2X_DIRECTIVE_OPT=""
if [[ ${user_directive} == true ]]; then
  OMNI_CX2X_DIRECTIVE_OPT="--directive=${directive_opt}"
fi

# Set the correct column option for the decompiler
OMNI_CX2X_MAX_COLUMN_OPT=""
if [[ ${decompiler_max_column} == true ]]; then
  OMNI_CX2X_MAX_COLUMN_OPT="-w ${max_columns}"
else
  OMNI_CX2X_MAX_COLUMN_OPT="-w 80"
fi

# Set the correct line directive option for the decompiler
OMNI_CX2X_LINE_OPT="-l"
if [[ ${line_directive} == true ]]; then
  OMNI_CX2X_LINE_OPT=""
fi

if [[ ${force_pure} == true ]]; then
  TRANSLATOR_OPTION="${TRANSLATOR_OPTION} --force-pure"
fi

# Module search path option
OMNI_CX2X_MOD_OPT=""
if [[ ${#module_opt[@]} -ne 0 ]]; then
  for mod in "${module_opt[@]}"; do
    OMNI_CX2X_MOD_OPT="${OMNI_CX2X_MOD_OPT} ${mod}"
  done
fi

### Show config ###
if [[ ${show_config} == true ]]; then
  # shellcheck disable=SC2086
  ${OMNI_FX2X_CMD} ${OMNI_FX2X_OPT} --show-config ${OMNI_CX2X_CONFIG_OPT}
  exit 0
fi

claw::check_file_exist

## Check if multiple file, output_dir must be specified and output_file not
if [ ${#f_files[@]} -gt 1 ] && [ "${output_dir}" == "" ]; then
  # Error: multiple files without output directory specified
  claw::error_exit "Error: output directory not specified"
elif [ "${output_file}" != "" ] && [ "${output_dir}" != "" ]; then
  # Error: output file and output directory defined at the same time
  claw::error_exit \
    "Error: output directory and output file cannot be specified together"
fi



### Create temporal directory ###
[[ ${enable_debug} == true ]] && temp_dir=${debug_temp_dir}
[[ ${enable_debug_omni} == true ]] && temp_dir=${debug_temp_dir}
mkdir -p ${temp_dir}
claw::verbose "Create ${temp_dir}/"

### Bypass file without code transformation ###
for input_file in "${f_files[@]}"; do
  if ! [[ ${force_translation} == true ]]; then
    num_directives="$(grep --count --ignore-case "!\$claw" "${input_file}")"
    num_omp_compile_guard="$(grep --count --ignore-case "!\$omp claw-guard" "${input_file}")"
    num_acc_compile_guard="$(grep --count --ignore-case "!\$acc claw-guard" "${input_file}")"
    if [[ "${num_directives}" == "0" ]] \
      && [[ "${num_omp_compile_guard}" == "0" ]] \
      && [[ "${num_acc_compile_guard}" == "0" ]]; then
      claw::warning "${input_file}" "-" "file does not contains \$claw. Skip..."
      if [[ "${output_dir}" != "" ]]; then
        cp "${input_file}" "${output_dir}"/"${input_file}"
      else
        cp "${input_file}" "${output_file}"
      fi
    else
      f_files_transformation+=("${input_file}")
    fi
  else
    f_files_transformation+=("${input_file}")
  fi
done

### TODO check if f_files_transformation has any files in ...

### Preprocessor ###
[[ ${only_pp} == true ]] && [[ -f "${output_file}" ]] && rm "${output_file}"
[[ ${enable_cpp} == true ]] && OMNI_FPP_OPT="${OMNI_FPP_OPT} ${CPP_OPT}"
for input_file in "${f_files_transformation[@]}"; do
  claw::verbose "Prepocessing ..."

  file_name="$(claw::norm_file_name "${input_file}")"
  base_name="$(basename "${input_file}")"
  ext=${input_file##*.}
  file_pp1=${temp_dir}/"${file_name}".pp1.${ext} # temp file for preprocessing 1
  file_pp2=${temp_dir}/"${file_name}".pp2.${ext} # temp file for preprocessing 2
  file_pp=${temp_dir}/"${base_name}" # preprocessed file with original name
  preprocessor_output="$(basename "${file_pp%.*}")"

  if [[ "${ext}" == "F90" ]] || [[ "${ext}" == "F" ]] \
    || [[ ${enable_cpp} == true ]]; then

    # Apply pre preprocessor pass to avoid ending backslash error
    claw::applyPreprocessorPass "${input_file}" "${file_pp1}"
    mv "${file_pp1}" "${file_pp}"

    if [[ ${fpp_redirect} == true ]]; then
      # Debug output
      [[ ${enable_debug} == true ]] && echo "CLAW DRIVER: Preprocessing"
      [[ ${enable_debug} == true ]] && echo "${OMNI_FPP_CMD} ${include_opt[*]} \
        ${pp_add_opt[*]} ${OMNI_FPP_OPT} ${other_args[*]} ${file_pp} > \
        ${file_pp2}"

      # Call to the preprocessor
      # shellcheck disable=SC2086,SC2068
      ${OMNI_FPP_CMD} ${include_opt[@]} ${pp_add_opt[@]} \
        ${OMNI_FPP_OPT} ${other_args[@]} "${file_pp}" > "${file_pp2}"

      mv "${file_pp2}" "${file_pp}"
    else
      # Debug output
      [[ ${enable_debug} == true ]] && echo "CLAW DRIVER: Preprocessing"
      [[ ${enable_debug} == true ]] && echo "${OMNI_FPP_CMD} ${include_opt[*]} \
        ${pp_add_opt[*]} ${OMNI_FPP_OPT} ${other_args[*]} ${file_pp}"
      [[ ${enable_debug} == true ]] && echo "mv ${preprocessor_output}.i \
        ${file_pp}"

      # Call to the preprocessor
      # shellcheck disable=SC2086,SC2068
      ${OMNI_FPP_CMD} ${include_opt[@]} ${pp_add_opt[@]} \
        ${OMNI_FPP_OPT} ${other_args[@]} "${file_pp}"

      mv "${preprocessor_output}.i" "${file_pp}"
    fi

    if [[ ${only_pp} == true ]]; then
      if [[ "${output_file}" = "" ]]; then
        cat "${file_pp}"
      else
        cat "${file_pp}" >> "${output_file}" # TODO debug here
      fi
    fi
  fi
done
[[ ${stop_pp} == true ]] && exit 0;
[[ ${only_pp} == true ]] && [[ ${enable_debug} == true ]] && exit 0;
[[ ${only_pp} == true ]] && { rm -rf ${temp_dir}; exit 0; }

### Apply ignore directive
for input_file in "${f_files_transformation[@]}"; do
  file_name="$(claw::norm_file_name "${input_file}")"
  ext=${input_file##*.}
  base_name="$(basename "${input_file}")"
  if [[ "${ext}" == "F90" ]] || [[ "${ext}" == "F" ]] \
    || [[ ${enable_cpp} == true ]]; then
    file_pp=${temp_dir}/"${base_name}"
  else
    # TODO not correct file name as iignore is applied in place
    file_pp="${input_file}"
  fi
  claw::applyIgnore "${file_pp}"
done

### dependencies resolution ###
if [[ ${resolve_dependencies} == true ]]; then
  for input_file in "${f_files_transformation[@]}"; do
    claw::verbose "Dependencies resolution ..."
    file_name="$(claw::norm_file_name "${input_file}")"
    ext=${input_file##*.}
    base_name="$(basename "${input_file}")"
    if [[ "${ext}" == "F90" ]] || [[ "${ext}" == "F" ]] \
      || [[ ${enable_cpp} == true ]]; then
      file_pp=${temp_dir}/"${base_name}"
    else
      file_pp="${input_file}"
    fi

    claw::process_dependencies "${file_pp}" "${input_file}"
  done
  [[ ${stop_dependencies} == true ]] && exit 0;
fi

### Frontend ###
for input_file in "${f_files_transformation[@]}"; do
  claw::verbose "Fortran to XcodeML ..."
  file_name="$(claw::norm_file_name "${input_file}")"
  ext=${input_file##*.}
  base_name="$(basename "${input_file}")"
  if [[ "${ext}" == "F90" ]] || [[ "${ext}" == "F" ]] \
    || [[ ${enable_cpp} == true ]]; then
    file_pp=${temp_dir}/"${base_name}"
  else
    file_pp="${input_file}"
  fi
  file_in_x=${temp_dir}/"${file_name}"_${ext}_in.xml

  # Check that input file produced by preprocessing pass exists.
  if [[ ! -f ${file_pp} ]]; then
    claw::error_exit \
      "Input file not preprocessed correctly. Parsing cannot be done."
  fi

  # Debug output
  [[ ${enable_debug} == true ]] && echo "CLAW DRIVER: Front-end"
  # shellcheck disable=SC2153,SC2086
  [[ ${enable_debug} == true ]] && echo "${OMNI_F2X_CMD} ${include_opt[*]} \
    ${module_opt[*]} ${frontend_add_opt[*]} ${OMNI_F2X_OPT} ${file_pp} -o  \
    ${file_in_x}"

  # Call F_Front with the correct arguments
  # shellcheck disable=SC2153,SC2086
  ${OMNI_F2X_CMD} "${include_opt[@]}" "${module_opt[@]}" \
    "${frontend_add_opt[@]}" ${OMNI_F2X_OPT} "${file_pp}" -o "${file_in_x}"
done
[[ ${stop_frontend} == true ]] && exit 0;

# Add debug flag for the translator options
if [[ ${enable_debug} == true ]]; then
  TRANSLATOR_OPTION="${TRANSLATOR_OPTION} -d"
fi

### Translator ###
for input_file in "${f_files_transformation[@]}"; do
  claw::verbose "XcodeML to XcodeML translation ..."
  file_name="$(claw::norm_file_name "${input_file}")"
  ext=${input_file##*.}
  file_in_x=${temp_dir}/"${file_name}"_${ext}_in.xml

  # Check that input file produced by parsing pass exists.
  if [[ ! -f ${file_in_x} ]]; then
    claw::error_exit \
      "Input file not parsed correctly. Translation cannot be done."
  fi

  file_out_x=${temp_dir}/"${file_name}"_${ext}_out.xml
  file_out_f=${temp_dir}/"${input_file}"
  if [[ "${output_file}" != "" ]]; then
    file_out_f=${output_file}
  elif [[ "${output_dir}" != "" ]]; then
    file_out_f=${output_dir}/${input_file}
  fi

  # Define report file output
  if [ ${report} == true ]; then
    file_out_r="${file_out_f%.*}"
    file_out_r="${file_out_r}.lst"
    TRANSLATOR_OPTION="${TRANSLATOR_OPTION} --report=${file_out_r}"
  fi

  # Dump the arguments pass to the translator for easier debugging
  if [[ ${dump_cx2x_args} == true ]]; then
    echo "-- [DEBUG] Arguments for omni-cx2x:"
    echo "${TRANSLATOR_OPTION} ${OMNI_CX2X_TARGET_OPT} \
      ${OMNI_CX2X_DIRECTIVE_OPT} ${OMNI_CX2X_CONFIG_OPT} \
      ${OMNI_CX2X_MAX_COLUMN_OPT} ${OMNI_CX2X_LINE_OPT} \
      ${xcode_translator_add_opt[*]} ${module_opt[*]} ${trans_module_opt[*]} \
      -o ${file_out_x} -f ${file_out_f} ${file_in_x}"
  fi

  # Debug output
  [[ ${enable_debug} == true ]] && echo "CLAW DRIVER: Translation + backend"
  [[ ${enable_debug} == true ]] && echo "${OMNI_FX2X_CMD} ${OMNI_FX2X_OPT} \
    ${TRANSLATOR_OPTION} ${OMNI_CX2X_TARGET_OPT} ${OMNI_CX2X_DIRECTIVE_OPT} \
    ${OMNI_CX2X_CONFIG_OPT} ${OMNI_CX2X_MAX_COLUMN_OPT} ${OMNI_CX2X_LINE_OPT} \
    ${xcode_translator_add_opt[*]} ${module_opt[*]} ${trans_module_opt[*]} -o \
    ${file_out_x} -f ${file_out_f} ${file_in_x}"

  # Call to the translator
  # shellcheck disable=SC2086
  ${OMNI_FX2X_CMD} ${OMNI_FX2X_OPT} ${TRANSLATOR_OPTION} \
    ${OMNI_CX2X_TARGET_OPT} ${OMNI_CX2X_DIRECTIVE_OPT} ${OMNI_CX2X_CONFIG_OPT} \
    ${OMNI_CX2X_MAX_COLUMN_OPT} ${OMNI_CX2X_LINE_OPT} \
    "${xcode_translator_add_opt[@]}" "${module_opt[@]}" \
    "${trans_module_opt[@]}" -o "${file_out_x}" -f "${file_out_f}" \
    "${file_in_x}"

  # Check that translation output a file
  if [[ ! -f ${file_out_x} ]]; then
    claw::error_exit "Translation failed."
  fi

  # Check that decompiler output a file
  if [[ ! -f ${file_out_f} ]]; then
    claw::error_exit "Decompiler failed."
  fi

  # also create ${temp_dir}/${file_name}_${ext}_in.F90
  # Note : The BlueGene/Q 's mpi compiler can compile only *.F90 in XMP process.
  # So that remains .F90 extention after process of the native compilier.
done
[[ ${stop_translator} == true ]] && exit 0;

### Revert ignore prefix and apply verbatim
for input_file in "${f_files_transformation[@]}"; do
  if [[ "${output_file}" != "" ]]; then
    file_out_f=${output_file}
  elif [[ "${output_dir}" != "" ]]; then
    file_out_f=${output_dir}/${input_file}
  fi
  claw::revertIgnore "${file_out_f}"
  claw::applyVerbatim "${file_out_f}"
done

### Delete temporal directory ###
if [[ ${enable_debug_omni} == false ]] && [[ ${enable_debug} == false ]]; then
  rm -rf ${temp_dir}
fi

exit 0
