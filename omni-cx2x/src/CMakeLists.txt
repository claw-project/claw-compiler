# This file is released under terms of BSD license
# See LICENSE file for more information

# CLAW XcodeML manipulation library and translator library

# ANTLR
set(ANTLR_JAR ${PROJECT_BINARY_DIR}/build/${ANTLR_NAME}.jar)

# Try to download the jar dependencies
if(NOT EXISTS ${ANTLR_JAR})
  message("Try to download antlr dependency")
  file(
    DOWNLOAD
    http://www.antlr.org/download/antlr-4.5.2-complete.jar
    ${ANTLR_JAR}
    STATUS status
  )

  list( GET status 0 error_code )
  if( error_code )
    file( REMOVE ${ANTLR_JAR} )
    message(FATAL_ERROR "File ${ANTLR_JAR} cannot be downloaded. Download it manually and store it in ${PROJECT_BINARY_DIR}/build/")
  endif()
endif()

# Set jar dependencies in the Java classpath
set(
  CMAKE_JAVA_INCLUDE_PATH
  ${CMAKE_SOURCE_DIR}/omni-compiler/XcodeML-Common/build/om-common.jar
  ${CMAKE_SOURCE_DIR}/omni-compiler/XcodeML-Exc-Tools/build/om-exc-tools.jar
  ${ANTLR_JAR}
)

set(CMAKE_JAVA_COMPILE_FLAGS -Xlint:unchecked)

# Add subdirectory for ANTLR CLAW Parser generation
set(CLAW_PARSER_DIR "cx2x/translator/language")
add_subdirectory(${CLAW_PARSER_DIR})

# XcodeML manipulation library
add_jar(${OMNI_CX2X_XCODEML_NAME}

# XcodeML.error package
  cx2x/xcodeml/error/XanalysisError.java

# XcodeML.Xelement.Exception package
  cx2x/xcodeml/exception/IllegalDirectiveException.java
  cx2x/xcodeml/exception/IllegalTransformationException.java

# XcodeML.helper package
  cx2x/xcodeml/helper/XelementHelper.java

# XcodeML.language
  cx2x/xcodeml/language/AnalyzedPragma.java

# XcodeML.transformation
  cx2x/xcodeml/transformation/BlockTransformation.java
  cx2x/xcodeml/transformation/DependentTransformationGroup.java
  cx2x/xcodeml/transformation/IndependentTransformationGroup.java
  cx2x/xcodeml/transformation/Transformation.java
  cx2x/xcodeml/transformation/TransformationGroup.java
  cx2x/xcodeml/transformation/Transformer.java

# XcodeML.xnode package
  cx2x/xcodeml/xnode/XbasicType.java
  cx2x/xcodeml/xnode/XcodeProgram.java
  cx2x/xcodeml/xnode/Xdecl.java
  cx2x/xcodeml/xnode/XdeclTable.java
  cx2x/xcodeml/xnode/XelementName.java
  cx2x/xcodeml/xnode/XfunctionDefinition.java
  cx2x/xcodeml/xnode/XfunctionType.java
  cx2x/xcodeml/xnode/XglobalDeclTable.java
  cx2x/xcodeml/xnode/XglobalSymbolTable.java
  cx2x/xcodeml/xnode/Xid.java
  cx2x/xcodeml/xnode/Xintent.java
  cx2x/xcodeml/xnode/XmoduleDefinition.java
  cx2x/xcodeml/xnode/Xparams.java
  cx2x/xcodeml/xnode/Xscope.java
  cx2x/xcodeml/xnode/XsymbolTable.java
  cx2x/xcodeml/xnode/Xtype.java
  cx2x/xcodeml/xnode/XtypeTable.java
  cx2x/xcodeml/xnode/XvarDecl.java
  cx2x/xcodeml/xnode/Xattr.java
  cx2x/xcodeml/xnode/Xcode.java
  cx2x/xcodeml/xnode/Xnode.java

  OUTPUT_DIR ${PROJECT_BINARY_DIR}/build
)

# CLAW translator specific library
add_jar(${OMNI_CX2X_CLAW_NAME}
# Base class
  cx2x/Cx2x.java

# decompiler package
  cx2x/decompiler/FortranDecompiler.java

# translator.common package
  cx2x/translator/common/ConfigurationHelper.java
  cx2x/translator/common/Constant.java
  cx2x/translator/common/GroupConfiguration.java
  cx2x/translator/common/NestedDoStatement.java

# translator.language package
  cx2x/translator/language/ClawBaseListener.java    # Generated by ANTLR
  cx2x/translator/language/ClawDirective.java
  cx2x/translator/language/ClawErrorListener.java
  cx2x/translator/language/ClawLanguage.java
  cx2x/translator/language/ClawLexer.java           # Generated by ANTLR
  cx2x/translator/language/ClawListener.java        # Generated by ANTLR
  cx2x/translator/language/ClawMapping.java
  cx2x/translator/language/ClawMappingVar.java
  cx2x/translator/language/ClawParser.java          # Generated by ANTLR
  cx2x/translator/language/ClawRange.java
  cx2x/translator/language/ClawReshapeInfo.java

# translator.language.helper package
  cx2x/translator/language/helper/TransformationHelper.java

# translator.language.helper.accelerator package
  cx2x/translator/language/helper/accelerator/AcceleratorDirective.java
  cx2x/translator/language/helper/accelerator/AcceleratorGenerator.java
  cx2x/translator/language/helper/accelerator/AcceleratorHelper.java
  cx2x/translator/language/helper/accelerator/OpenAcc.java
  cx2x/translator/language/helper/accelerator/OpenMp.java

# translator.language.helper.accelerator package
  cx2x/translator/language/helper/target/Target.java

# translator.misc package
  cx2x/translator/misc/Utility.java

# translator package
  cx2x/translator/ClawDirectiveKey.java
  cx2x/translator/ClawXcodeMlTranslator.java

# translator.transformer package
  cx2x/translator/transformer/ClawTransformer.java

# translator.transformation package
  cx2x/translator/transformation/claw/ArrayToFctCall.java
  cx2x/translator/transformation/claw/Kcaching.java
  cx2x/translator/transformation/claw/Parallelize.java
  cx2x/translator/transformation/loop/ArrayTransform.java
  cx2x/translator/transformation/loop/LoopExtraction.java
  cx2x/translator/transformation/loop/LoopFusion.java
  cx2x/translator/transformation/loop/LoopHoist.java
  cx2x/translator/transformation/loop/LoopHoistDoStmtGroup.java
  cx2x/translator/transformation/loop/LoopInterchange.java
  cx2x/translator/transformation/openacc/OpenAccContinuation.java
  cx2x/translator/transformation/utility/UtilityRemove.java

  OUTPUT_DIR ${PROJECT_BINARY_DIR}/build
)

# Add dependency between the CLAW translator library and the parser generation
add_dependencies(${OMNI_CX2X_CLAW_NAME} claw-antlr)

install(FILES ${PROJECT_BINARY_DIR}/build/${OMNI_CX2X_CLAW_NAME}.jar DESTINATION ${CMAKE_INSTALL_PREFIX}/share/cx2x/)
install(FILES ${PROJECT_BINARY_DIR}/build/${OMNI_CX2X_XCODEML_NAME}.jar DESTINATION ${CMAKE_INSTALL_PREFIX}/share/cx2x/)
install(FILES ${PROJECT_BINARY_DIR}/build/${ANTLR_NAME}.jar DESTINATION ${CMAKE_INSTALL_PREFIX}/share/cx2x/)
